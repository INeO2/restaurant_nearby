import streamlit as st
import pandas as pd
import openai 
import os
from datetime import datetime, timedelta
import time 
from streamlit_mic_recorder import mic_recorder
import json 
import requests 
from bs4 import BeautifulSoup 
import re 
from typing import List, Dict, Union
import urllib3

# SSL ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¹€
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# -----------------------------------------------------------------
# ğŸ”’ [ë³´ì•ˆ ìˆ˜ì •] OPENAI_API_KEY ì„¤ì • (secrets.tomlì—ì„œ ë¡œë“œ)
# -----------------------------------------------------------------
# .streamlit/secrets.toml íŒŒì¼ì— ì €ì¥ëœ í‚¤ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
if "OPENAI_API_KEY" in st.secrets:
    os.environ['OPENAI_API_KEY'] = st.secrets["OPENAI_API_KEY"]
else:
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©: secrets íŒŒì¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì§ì ‘ ì…ë ¥ ë°›ê±°ë‚˜ ì—ëŸ¬ ì²˜ë¦¬
    # (ë°°í¬ ì‹œì—ëŠ” Streamlit Cloudì˜ Secrets ì„¤ì •ì— í‚¤ë¥¼ ë“±ë¡í•´ì•¼ í•¨)
    pass

# -----------------------------------------------------------------
# [ê¸°ëŠ¥ ìœ ì§€] ë™ì–‘ë¯¸ë˜ëŒ€í•™êµ ì›¹ì‚¬ì´íŠ¸ì—ì„œ í•™ì‹ ì£¼ê°„ ë©”ë‰´ í¬ë¡¤ë§
# -----------------------------------------------------------------
def get_weekly_campus_menu() -> List[Dict[str, str]]:
    """
    ì›¹ í¬ë¡¤ë§ì„ í†µí•´ ë™ì–‘ë¯¸ë˜ëŒ€í•™êµ í•™ì‹ ë©”ë‰´ ì£¼ê°„ ì „ì²´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    """
    try:
        today = datetime.now()
        
        # ì£¼ë§(í† ìš”ì¼=5, ì¼ìš”ì¼=6)ì´ë©´ 'ë‹¤ìŒ ì£¼ ì›”ìš”ì¼'ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
        if today.weekday() >= 5:
            monday = today + timedelta(days=(7 - today.weekday()))
        else:
            # í‰ì¼ì´ë©´ 'ì´ë²ˆ ì£¼ ì›”ìš”ì¼'ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •
            monday = today - timedelta(days=today.weekday())
            
        monday_str = monday.strftime("%Y.%m.%d")

        # í•´ë‹¹ ì£¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        url = f"https://www.dongyang.ac.kr/dmu/4902/subview.do?monday={monday_str}"

        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
        }
        
        response = requests.get(url, headers=headers, verify=False, timeout=10) 
        response.raise_for_status()

        soup = BeautifulSoup(response.text, 'html.parser')
        
        # 1. ë‚ ì§œ í—¤ë” ì¶”ì¶œ
        dates = []
        date_pattern = re.compile(r'\d{4}\.\d{2}\.\d{2}') 
        
        headers = soup.select('thead tr th')
        for th in headers:
            date_text = th.get_text(strip=True)
            match = date_pattern.search(date_text)
            if match:
                dates.append(match.group(0))
        
        if not dates:
            return [{"êµ¬ë¶„": "âš ï¸ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨", "ë©”ë‰´": "ì›¹ì‚¬ì´íŠ¸ ë‚ ì§œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}]

        # 2. ë©”ë‰´ ë°ì´í„° ì¶”ì¶œ
        weekly_data = []
        current_category = "í•™ì‹" 
        
        rows = soup.select('tbody tr')
        
        for tr in rows:
            cells = tr.find_all(['th', 'td'])
            
            if not cells:
                continue

            # Case A: ì¹´í…Œê³ ë¦¬ í—¤ë” í–‰
            if len(cells) == 1:
                text = cells[0].get_text(strip=True)
                if text:
                    current_category = text
                continue
            
            # Case B: ì‹¤ì œ ë©”ë‰´ ë°ì´í„° í–‰
            if len(cells) >= len(dates):
                row_data = {'êµ¬ë¶„': current_category}
                has_content = False
                
                for i, date in enumerate(dates):
                    if i < len(cells):
                        menu_text = cells[i].get_text('\n', strip=True)
                        menu_cleaned = " / ".join([t.strip() for t in menu_text.split('\n') if t.strip()])
                        
                        row_data[date] = menu_cleaned if menu_cleaned else "-"
                        if menu_cleaned and menu_cleaned != "-":
                            has_content = True
                    else:
                        row_data[date] = "-"
                
                if has_content:
                    weekly_data.append(row_data)

        if not weekly_data:
            return [{"êµ¬ë¶„": "âš ï¸ ë©”ë‰´ ì—†ìŒ", "ë©”ë‰´": "ì‹ë‹¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}]

        return weekly_data
        
    except requests.exceptions.RequestException as e:
        return [{"êµ¬ë¶„": "âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜", "ë©”ë‰´": f"ì ‘ì† ì‹¤íŒ¨: {e}"}]
    except Exception as e:
        return [{"êµ¬ë¶„": "âš ï¸ í¬ë¡¤ë§ ì˜¤ë¥˜", "ë©”ë‰´": f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"}]


# -----------------------------------------------------------------
# --- 1. ì‹ë‹¹ ë°ì´í„° (ìˆ˜ë™ ìˆ˜ì§‘) ---
# -----------------------------------------------------------------
RESTAURANT_DATA = [
    {"ì´ë¦„": "ë™ì–‘ë°±ë°˜", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ë‹­ë³¶ìŒíƒ•, ë¶ˆê³ ê¸° ë°±ë°˜, ê³ ë“±ì–´êµ¬ì´", "ê°€ê²©ëŒ€": "10,000ì›~13,000ì›", "í‰ê°€ ë‚´ìš©": "ì§‘ë°¥ ëŠë‚Œ/ë“ ë“ í•¨. ë°˜ì°¬ì´ ì •ê°ˆí•˜ê²Œ ì˜ ë‚˜ì˜´. ì ì‹¬ì‹œê°„ ì›¨ì´íŒ… ìˆì„ ìˆ˜ ìˆìŒ.", "ìš´ì˜ ì‹œê°„": "10:30 ~ 21:00 (ì¼ìš”ì¼ íœ´ë¬´)", "ê±°ë¦¬ ì •ë³´": "150m (ì •ë¬¸ ê±´ë„ˆí¸ ê³¨ëª©)"},
    {"ì´ë¦„": "í°ë§˜í• ë§¤ìˆœëŒ€êµ­", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ìˆœëŒ€êµ­, ìˆ˜ìœ¡êµ­ë°¥, ë¼ˆí•´ì¥êµ­", "ê°€ê²©ëŒ€": "8,000ì›~10,000ì›", "í‰ê°€ ë‚´ìš©": "í•´ì¥/í˜¼ë°¥. ì „ë‚  ìˆ  ë§ˆì…¨ìœ¼ë©´ í•„ìˆ˜ ì½”ìŠ¤. êµ­ë¬¼ì´ ì§„í•¨.", "ìš´ì˜ ì‹œê°„": "00:00 ~ 24:00 (24ì‹œê°„)", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "í•œì†¥ë„ì‹œë½ ë™ì–‘ë¯¸ë˜ëŒ€ì ", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ì¹˜í‚¨ë§ˆìš”, ë„ë ¨ë‹˜ë„ì‹œë½, ëˆê¹ŒìŠ¤ë®ë°¥", "ê°€ê²©ëŒ€": "4,500ì›~7,000ì›", "í‰ê°€ ë‚´ìš©": "ê°€ì„±ë¹„/ì‹ ì†. ëˆ ì•„ë¼ê³  ì‹¶ì„ ë•Œ ìµœê³ . í¬ì¥í•´ì„œ í•™êµ ë²¤ì¹˜ì—ì„œ ë¨¹ê¸° ì¢‹ìŒ.", "ìš´ì˜ ì‹œê°„": "08:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "50m (ì •ë¬¸ ë°”ë¡œ ì•)"},
    {"ì´ë¦„": "ì‹¸ë‹¤ê¹€ë°¥", "ì¢…ë¥˜": "í•œì‹/ë¶„ì‹", "ì£¼ìš” ë©”ë‰´": "ê¹€ë°¥, êµ­ë¬¼ë–¡ë³¶ì´, ëˆê¹ŒìŠ¤, ë®ë°¥ë¥˜", "ê°€ê²©ëŒ€": "4,500ì›~9,000ì›", "í‰ê°€ ë‚´ìš©": "ë‹¤ì–‘í•¨/ë¹ ë¦„. ë©”ë‰´ê°€ ì—„ì²­ ë§ì•„ì„œ ê²°ì •í•˜ê¸° í˜ë“¤ ë•Œ ê°€ë©´ ë­ë¼ë„ ê³ ë¥¼ ìˆ˜ ìˆìŒ.", "ìš´ì˜ ì‹œê°„": "00:00 ~ 24:00 (24ì‹œê°„)", "ê±°ë¦¬ ì •ë³´": "100m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "ëª…ê°€í•¨í¥ëƒ‰ë©´", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ë¬¼ëƒ‰ë©´, ë¹„ë¹”ëƒ‰ë©´, ê°ˆë¹„íƒ•, ë§Œë‘", "ê°€ê²©ëŒ€": "9,000ì›~13,000ì›", "í‰ê°€ ë‚´ìš©": "ì—¬ë¦„/ì‹œì›í•¨. ë”ìš´ ë‚  ì‚´ì–¼ìŒ ìœ¡ìˆ˜ ë§ˆì‹œë©´ ì²œêµ­. ê°ˆë¹„íƒ•ë„ ë“ ë“ í•¨.", "ìš´ì˜ ì‹œê°„": "10:30 ~ 21:30", "ê±°ë¦¬ ì •ë³´": "250m (ë¨¹ìê³¨ëª© ì•ˆìª½)"},
    {"ì´ë¦„": "ë³¸ì£½&ë¹„ë¹”ë°¥cafe", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ì „ë³µì£½, ì†Œê³ ê¸°ì•¼ì±„ì£½, ë‚™ì§€ë¹„ë¹”ë°¥", "ê°€ê²©ëŒ€": "10,000ì›~15,000ì›", "í‰ê°€ ë‚´ìš©": "ê±´ê°•/ì†Œí™”. ëª¸ì´ ìœ¼ìŠ¬ìœ¼ìŠ¬í•˜ê±°ë‚˜ ì† í¸í•œ ë°¥ ë¨¹ê³  ì‹¶ì„ ë•Œ.", "ìš´ì˜ ì‹œê°„": "09:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "150m (ëŒ€ë¡œë³€ 2ì¸µ)"},
    {"ì´ë¦„": "ë†€ë¶€ë¶€ëŒ€ì°Œê°œ", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ë¶€ëŒ€ì°Œê°œ, ë¼ë©´ì‚¬ë¦¬", "ê°€ê²©ëŒ€": "10,000ì›~12,000ì›", "í‰ê°€ ë‚´ìš©": "ë‹¨ì²´/ì–¼í°. ì¹œêµ¬ 3~4ëª…ì´ì„œ ë¼ë©´ì‚¬ë¦¬ ë„£ê³  í‘¸ì§í•˜ê²Œ ë¨¹ê¸° ì¢‹ìŒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "ìƒˆë§ˆì„ì‹ë‹¹", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "7ë¶„ë¼ì§€ê¹€ì¹˜, ì—´íƒ„ë¶ˆê³ ê¸°", "ê°€ê²©ëŒ€": "8,000ì›~13,000ì›", "í‰ê°€ ë‚´ìš©": "ë°¥ë„ë‘‘/ë¹„ë²¼ë¨¹ê¸°. ê¹€ê°€ë£¨ ë¿Œë ¤ì„œ ë°¥ ë¹„ë²¼ ë¨¹ìœ¼ë©´ í•œ ê·¸ë¦‡ ìˆœì‚­.", "ìš´ì˜ ì‹œê°„": "11:30 ~ 23:00", "ê±°ë¦¬ ì •ë³´": "250m (ë¨¹ìê³¨ëª© ì¤‘ì•™)"},
    {"ì´ë¦„": "ì½©ë¶ˆ", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ì½©ë‚˜ë¬¼ë¶ˆê³ ê¸°, ë³¶ìŒë°¥", "ê°€ê²©ëŒ€": "8,000ì›~10,000ì›", "í‰ê°€ ë‚´ìš©": "ê°€ì„±ë¹„/ë§¤ì½¤. ë‹¤ ë¨¹ê³  ë°¥ ë³¶ì•„ ë¨¹ëŠ” ê²Œ êµ­ë£°.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "ì§šì‹ ë§¤ìš´ê°ˆë¹„ì°œ", "ì¢…ë¥˜": "í•œì‹", "ì£¼ìš” ë©”ë‰´": "ë¼ì§€ê°ˆë¹„ì°œ, ì£¼ë¨¹ë°¥, ê³„ë€ì°œ", "ê°€ê²©ëŒ€": "14,000ì›~", "í‰ê°€ ë‚´ìš©": "ìŠ¤íŠ¸ë ˆìŠ¤/ë§¤ìš´ë§›. ì‹œí—˜ ë§ì¹œ ë‚  ë§¤ìš´ ê±° ë¨¹ê³  ë•€ í˜ë¦¬ê¸° ì¢‹ìŒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 23:00", "ê±°ë¦¬ ì •ë³´": "300m (ë¨¹ìê³¨ëª© ê¹Šì€ ê³³)"},
    {"ì´ë¦„": "ìš°ë™ê¹Œë™", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "ìˆ˜ì œëˆê¹ŒìŠ¤, ê¹€ì¹˜ìš°ë™, ì¹´ë ˆë®ë°¥", "ê°€ê²©ëŒ€": "8,000ì›~11,000ì›", "í‰ê°€ ë‚´ìš©": "ë§›ì§‘/ì›¨ì´íŒ…. í•™ìƒë“¤ ì‚¬ì´ì—ì„œ ìœ ëª…í•¨. ìš°ë™ ë©´ë°œì´ ì«„ê¹ƒí•¨.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 20:30 (ì£¼ë§ íœ´ë¬´)", "ê±°ë¦¬ ì •ë³´": "400m (í•™êµ ë’·í¸ ê³¨ëª©)"},
    {"ì´ë¦„": "ë°±ì†Œì • ê³ ì²™ì ", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "ë§ˆì œì†Œë°”, ëˆì¹´ì¸ , ëƒ‰ì†Œë°”", "ê°€ê²©ëŒ€": "9,500ì›~13,000ì›", "í‰ê°€ ë‚´ìš©": "ê¹”ë”/ë°ì´íŠ¸. ì¸í…Œë¦¬ì–´ê°€ ê¹¨ë—í•˜ê³  ë§›ì´ ì •ê°ˆí•¨. í˜¸ë¶ˆí˜¸ ì—†ìŒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "150m (ëŒ€ë¡œë³€ 2ì¸µ)"},
    {"ì´ë¦„": "ëª…ì¥í…", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "í…ë™(ëª¨ë‘ íŠ€ê¹€ë®ë°¥), ìŠ¤í˜ì…œí…ë™", "ê°€ê²©ëŒ€": "11,000ì›~15,000ì›", "í‰ê°€ ë‚´ìš©": "ë¹„ì£¼ì–¼/íŠ€ê¹€. ê°“ íŠ€ê¸´ ë°”ì‚­í•œ íŠ€ê¹€ì´ ë¨¹ê³  ì‹¶ì„ ë•Œ.", "ìš´ì˜ ì‹œê°„": "11:30 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "150m (ë¨¹ìê³¨ëª© ì´ˆì…)"},
    {"ì´ë¦„": "ì—­ì „ìš°ë™0410", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "ì˜›ë‚ ìš°ë™, ë§¤ìš´ëª¨ë‘ ì–´ë¬µìš°ë™, ëª…ë€ë¯¸ë‹ˆë®ë°¥", "ê°€ê²©ëŒ€": "5,000ì›~8,000ì›", "í‰ê°€ ë‚´ìš©": "ì´ˆê°€ì„±ë¹„/í˜¼ë°¥. ì£¼ë¨¸ë‹ˆ ê°€ë²¼ìš¸ ë•Œ ë¶€ë‹´ ì—†ì´ ê°€ê¸° ì¢‹ìŒ. ë°”í…Œì´ë¸”.", "ìš´ì˜ ì‹œê°„": "10:00 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "100m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "ê³ ë¯¸ë¼ë©˜", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "ëˆì½”ì¸ ë¼ë©˜, ì¹´ë¼ë¼ë©˜, ì°¨ìŠˆë®ë°¥", "ê°€ê²©ëŒ€": "8,500ì›~10,000ì›", "í‰ê°€ ë‚´ìš©": "í˜¼ë°¥/êµ­ë¬¼. ì§„í•œ ë¼ì§€ìœ¡ìˆ˜ êµ­ë¬¼ ìƒê°ë‚  ë•Œ. í˜¼ì ë¨¹ê¸° í¸í•œ ë¶„ìœ„ê¸°.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "250m (ë¨¹ìê³¨ëª© ì•ˆìª½)"},
    {"ì´ë¦„": "ì´ˆë°¥ì§“ëŠ”ì•„ì €ì”¨", "ì¢…ë¥˜": "ì¼ì‹", "ì£¼ìš” ë©”ë‰´": "ëŸ°ì¹˜ì´ˆë°¥ì„¸íŠ¸, ì—°ì–´ì´ˆë°¥", "ê°€ê²©ëŒ€": "12,000ì›~18,000ì›", "í‰ê°€ ë‚´ìš©": "ì´ˆë°¥/ê°€ì„±ë¹„. ì ì‹¬ íŠ¹ì„  êµ¬ì„±ì´ ì•Œì°¸. íšŒê°€ ì‹ ì„ í•¨.", "ìš´ì˜ ì‹œê°„": "11:30 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "í™ì½©ë°˜ì 0410", "ì¢…ë¥˜": "ì¤‘ì‹", "ì£¼ìš” ë©”ë‰´": "ì§¬ë½•, ì§œì¥ë©´, íƒ•ìˆ˜ìœ¡, êµ°ë§Œë‘", "ê°€ê²©ëŒ€": "7,000ì›~15,000ì›", "í‰ê°€ ë‚´ìš©": "ë¹„ì˜¤ëŠ”ë‚ /ì‹¤íŒ¨ì—†ìŒ. ì§¬ë½• êµ­ë¬¼ì´ ë•¡ê¸¸ ë•Œ ê°€ì¥ ë¬´ë‚œí•œ ì„ íƒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 21:30", "ê±°ë¦¬ ì •ë³´": "150m (ë¨¹ìê³¨ëª© ì´ˆì… 2ì¸µ)"},
    {"ì´ë¦„": "ë§ˆë¼í™€ë¦­ ë§ˆë¼íƒ•", "ì¢…ë¥˜": "ì¤‘ì‹", "ì£¼ìš” ë©”ë‰´": "ë§ˆë¼íƒ•, ê¿”ë°”ë¡œìš°, ë©˜ë³´ìƒ¤", "ê°€ê²©ëŒ€": "10,000ì›~ (ë¬´ê²Œë”°ë¼ ë‹¤ë¦„)", "í‰ê°€ ë‚´ìš©": "ìŠ¤íŠ¸ë ˆìŠ¤/ë‚´ë§˜ëŒ€ë¡œ. ì›í•˜ëŠ” ì¬ë£Œ ë‹´ì•„ì„œ ë§µê¸° ì¡°ì ˆ ê°€ëŠ¥. ì¤‘ë…ì„± ìˆìŒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "í™©ì œì§¬ë½•", "ì¢…ë¥˜": "ì¤‘ì‹", "ì£¼ìš” ë©”ë‰´": "í™©ì œì§¬ë½•, ì°¹ìŒ€íƒ•ìˆ˜ìœ¡", "ê°€ê²©ëŒ€": "9,000ì›~12,000ì›", "í‰ê°€ ë‚´ìš©": "í•´ë¬¼/í‘¸ì§. í•´ì‚°ë¬¼ì´ ë§ì´ ë“¤ì–´ê°€ êµ­ë¬¼ì´ ì‹œì›í•¨. ì–‘ì´ ë§ìŒ.", "ìš´ì˜ ì‹œê°„": "10:30 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "300m (ë¨¹ìê³¨ëª© ì•ˆìª½)"},
    {"ì´ë¦„": "ì•„ê°€í˜", "ì¢…ë¥˜": "ì–‘ì‹", "ì£¼ìš” ë©”ë‰´": "ì™•ëˆê¹ŒìŠ¤ì •ì‹, ìƒì„ ê¹ŒìŠ¤, ê¹€ì¹˜ë³¶ìŒë°¥", "ê°€ê²©ëŒ€": "7,000ì›~9,000ì›", "í‰ê°€ ë‚´ìš©": "ì „ì„¤/ì–‘ë§ìŒ. í•™êµ ì• ì „í†µ ë§›ì§‘. ì§„ì§œ ë°° í„°ì§€ê²Œ ë¨¹ê³  ì‹¶ì„ ë•Œ ì¶”ì²œ.", "ìš´ì˜ ì‹œê°„": "10:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "50m (ì •ë¬¸ ë°”ë¡œ ì• ì§€í•˜)"},
    {"ì´ë¦„": "ë§˜ìŠ¤í„°ì¹˜", "ì¢…ë¥˜": "ì–‘ì‹/íŒ¨ìŠ¤íŠ¸í‘¸ë“œ", "ì£¼ìš” ë©”ë‰´": "ì‹¸ì´ë²„ê±°ì„¸íŠ¸, ë¶ˆê³ ê¸°ë²„ê±°, ì¹˜í‚¨", "ê°€ê²©ëŒ€": "6,500ì›~9,000ì›", "í‰ê°€ ë‚´ìš©": "ì¹˜í‚¨íŒ¨í‹°/ê°„ë‹¨. ì‹œê°„ ì—†ì„ ë•Œ í–„ë²„ê±° í•˜ë‚˜ë¡œ í•´ê²°.", "ìš´ì˜ ì‹œê°„": "10:30 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "100m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "ì¨ë¸Œì›¨ì´ ê³ ì²™ë”ì ", "ì¢…ë¥˜": "ì–‘ì‹", "ì£¼ìš” ë©”ë‰´": "ì´íƒˆë¦¬ì•ˆë¹„ì— í‹°, ì—ê·¸ë§ˆìš”, ì¿ í‚¤ì„¸íŠ¸", "ê°€ê²©ëŒ€": "7,000ì›~10,000ì›", "í‰ê°€ ë‚´ìš©": "ë‹¤ì´ì–´íŠ¸/ì‹ ì„ . ì•¼ì±„ ë§ì´ ë¨¹ê³  ì‹¶ì„ ë•Œ. ë¹µ/ì†ŒìŠ¤ ì»¤ìŠ¤í…€ ê°€ëŠ¥.", "ìš´ì˜ ì‹œê°„": "08:00 ~ 23:00", "ê±°ë¦¬ ì •ë³´": "150m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "í”„ë­í¬ë²„ê±°", "ì¢…ë¥˜": "ì–‘ì‹", "ì£¼ìš” ë©”ë‰´": "í”„ë­í¬ë²„ê±°, ì¹˜ì¦ˆë²„ê±°, ê°ìíŠ€ê¹€", "ê°€ê²©ëŒ€": "5,000ì›~9,000ì›", "í‰ê°€ ë‚´ìš©": "ìˆ˜ì œë²„ê±°/ìœ¡ì¦™. íŒ¨ìŠ¤íŠ¸í‘¸ë“œë³´ë‹¤ ì¢€ ë” ê³ ê¸° ë§›ì„ ëŠë¼ê³  ì‹¶ì„ ë•Œ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "250m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "ë¡¤ë§íŒŒìŠ¤íƒ€", "ì¢…ë¥˜": "ì–‘ì‹", "ì£¼ìš” ë©”ë‰´": "í† ë§ˆí† íŒŒìŠ¤íƒ€, ì•Œë¦¬ì˜¤ì˜¬ë¦¬ì˜¤, ê³ ë¥´ê³¤ì¡¸ë¼í”¼ì", "ê°€ê²©ëŒ€": "8,000ì›~10,000ì›", "í‰ê°€ ë‚´ìš©": "íŒŒìŠ¤íƒ€/ê°€ì„±ë¹„. ì €ë ´í•œ ê°€ê²©ì— íŒŒìŠ¤íƒ€ë‘ í”¼ì ë¨¹ê¸° ì¢‹ìŒ.", "ìš´ì˜ ì‹œê°„": "11:30 ~ 21:30", "ê±°ë¦¬ ì •ë³´": "150m (ë¨¹ìê³¨ëª© ì´ˆì…)"},
    {"ì´ë¦„": "ê³ ì²™ëˆê¹ŒìŠ¤", "ì¢…ë¥˜": "ì–‘ì‹", "ì£¼ìš” ë©”ë‰´": "ë“±ì‹¬ëˆê¹ŒìŠ¤, ì¹´ë ˆëˆê¹ŒìŠ¤", "ê°€ê²©ëŒ€": "9,000ì›~11,000ì›", "í‰ê°€ ë‚´ìš©": "ë°”ì‚­í•¨/ì¹´ë ˆ. ì¼ë³¸ì‹ ëˆê¹ŒìŠ¤ì™€ ì¹´ë ˆ ì¡°í•©ì´ ê´œì°®ìŒ.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "350m (ì‹œì¥ ìª½)"},
    {"ì´ë¦„": "ë™ëŒ€ë¬¸ì—½ê¸°ë–¡ë³¶ì´", "ì¢…ë¥˜": "ë¶„ì‹", "ì£¼ìš” ë©”ë‰´": "ì—½ê¸°ë–¡ë³¶ì´, ì£¼ë¨¹ê¹€ë°¥, íŠ€ê¹€", "ê°€ê²©ëŒ€": "14,000ì› (2~3ì¸ë¶„)", "í‰ê°€ ë‚´ìš©": "ì—¬ëŸ¿ì´/ë§¤ìš´ë§›. ì¹œêµ¬ë“¤ì´ë‘ ìŠ¤íŠ¸ë ˆìŠ¤ í’€ ë•Œ. ì–‘ì´ ë§ì•„ í˜¼ìëŠ” ë¶ˆê°€.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:30", "ê±°ë¦¬ ì •ë³´": "200m (ë¨¹ìê³¨ëª© ë‚´)"},
    {"ì´ë¦„": "ì‹ ì „ë–¡ë³¶ì´", "ì¢…ë¥˜": "ë¶„ì‹", "ì£¼ìš” ë©”ë‰´": "ë–¡ë³¶ì´(ìˆœí•œ/ì¤‘ê°„/ë§¤ìš´), íŠ€ê¹€ì˜¤ë…, ì‹ ì „ê¹€ë°¥", "ê°€ê²©ëŒ€": "4,500ì›~8,000ì›", "í‰ê°€ ë‚´ìš©": "ì¤‘ë…ì„±/ì°ë¨¹. êµ­ë¬¼ì— íŠ€ê¹€ ì°ì–´ ë¨¹ìœ¼ë©´ ìµœê³ . ì¹´ë ˆí–¥ ë‚˜ëŠ” ë§¤ìš´ë§›.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:30", "ê±°ë¦¬ ì •ë³´": "150m (ë¨¹ìê³¨ëª© ì´ˆì…)"},
    {"ì´ë¦„": "ì´ì‚­í† ìŠ¤íŠ¸", "ì¢…ë¥˜": "ë¶„ì‹/ê°„ì‹", "ì£¼ìš” ë©”ë‰´": "í–„ì¹˜ì¦ˆí† ìŠ¤íŠ¸, ë² ì´ì»¨ë² ìŠ¤íŠ¸", "ê°€ê²©ëŒ€": "3,500ì›~5,000ì›", "í‰ê°€ ë‚´ìš©": "ë‹¬ë‹¬í•¨/ê°„ë‹¨. ë°¥ ë¨¹ê¸´ í—¤ë¹„í•˜ê³  ì•ˆ ë¨¹ê¸´ ë°°ê³ í”Œ ë•Œ.", "ìš´ì˜ ì‹œê°„": "09:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "100m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "íƒ€ì½”ë¹„", "ì¢…ë¥˜": "ë¶„ì‹/ê°„ì‹", "ì£¼ìš” ë©”ë‰´": "íƒ€ì½”ì•¼ë¼(ì˜¤ë¦¬ì§€ë„/ë§¤ìš´ë§›/ì¹˜ì¦ˆ)", "ê°€ê²©ëŒ€": "5,000ì›~", "í‰ê°€ ë‚´ìš©": "ê°„ì‹/ë§¥ì£¼ì•ˆì£¼. ê²‰ë°”ì†ì´‰. ìˆ˜ì—… ëë‚˜ê³  ì§‘ ê°€ëŠ” ê¸¸ì— í•˜ë‚˜ì”© ë¨¹ê¸° ì¢‹ìŒ.", "ìš´ì˜ ì‹œê°„": "12:00 ~ 23:00", "ê±°ë¦¬ ì •ë³´": "100m (ëŒ€ë¡œë³€)"},
    {"ì´ë¦„": "ëª…ë‘í•«ë„ê·¸", "ì¢…ë¥˜": "ê°„ì‹", "ì£¼ìš” ë©”ë‰´": "ê°ìí•«ë„ê·¸, ëª¨ì§œë ë¼í•«ë„ê·¸", "ê°€ê²©ëŒ€": "2,500ì›~3,500ì›", "í‰ê°€ ë‚´ìš©": "ë°”ì‚­/ì¹˜ì¦ˆ. ì„¤íƒ• ë¬»í˜€ì„œ ì†ŒìŠ¤ ë¿Œë ¤ ë¨¹ìœ¼ë©´ ê¿€ë§›.", "ìš´ì˜ ì‹œê°„": "11:00 ~ 22:00", "ê±°ë¦¬ ì •ë³´": "150m (ë¨¹ìê³¨ëª© ì´ˆì…)"},
    {"ì´ë¦„": "ë´‰êµ¬ìŠ¤ë°¥ë²„ê±°", "ì¢…ë¥˜": "ë¶„ì‹", "ì£¼ìš” ë©”ë‰´": "ë´‰êµ¬ìŠ¤ë°¥ë²„ê±°, í–„ì¹˜ì¦ˆë°¥ë²„ê±°", "ê°€ê²©ëŒ€": "3,000ì›~5,000ì›", "í‰ê°€ ë‚´ìš©": "ì´ˆì €ê°€/ë“ ë“ . ëˆ ì•„ë¼ê³  ì‹¶ì„ ë•Œ ìµœê³ ì˜ ê°€ì„±ë¹„.", "ìš´ì˜ ì‹œê°„": "10:00 ~ 21:00", "ê±°ë¦¬ ì •ë³´": "300m (ê³¨ëª© ì•ˆìª½)"}
]
df_static = pd.DataFrame(RESTAURANT_DATA)

# -----------------------------------------------------------------
# [ê¸°ëŠ¥ ìœ ì§€] íŒŒì¼ ì €ì¥ ì‹œìŠ¤í…œ (JSON)
# -----------------------------------------------------------------
DATA_FILE = "ratings.json"

def load_ratings():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
        except json.JSONDecodeError:
            pass
    return {item['ì´ë¦„']: {'total_score': 0.0, 'count': 0} for item in RESTAURANT_DATA}

def save_ratings(ratings_data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(ratings_data, f, ensure_ascii=False, indent=4)

if 'ratings' not in st.session_state:
    st.session_state.ratings = load_ratings()

if "messages" not in st.session_state:
    st.session_state.messages = []

# --- 2. ë™ì  ë°ì´í„° í”„ë ˆì„ ìƒì„± í•¨ìˆ˜ ---
def get_dynamic_dataframe():
    df_current = df_static.copy()
    
    def format_rating(name):
        if name not in st.session_state.ratings:
            st.session_state.ratings[name] = {'total_score': 0.0, 'count': 0}
            
        data = st.session_state.ratings[name]
        score = data['total_score'] / data['count'] if data['count'] > 0 else 0
        count = data['count']
        
        if count == 0:
            return "N/A (0ëª…)"
        
        return f"{score:.1f}/5.0 ({count}ëª…)"

    df_current['í•™ìƒ í‰ê°€'] = df_current['ì´ë¦„'].apply(format_rating)
    return df_current

# -----------------------------------------------------------------
# [ê¸°ëŠ¥ ìœ ì§€] AI í”„ë¡¬í”„íŠ¸ ìƒì„± (í•™ì‹ ë°ì´í„° í¬í•¨)
# -----------------------------------------------------------------
def get_system_prompt(df_data, weekly_menu_data):
    # 1. ì£¼ë³€ ì‹ë‹¹ ì •ë³´ ë³€í™˜
    restaurant_string = "\n".join([
        f"- {row['ì´ë¦„']}: {row['ì¢…ë¥˜']} | ë©”ë‰´: {row['ì£¼ìš” ë©”ë‰´']} | ê°€ê²©: {row['ê°€ê²©ëŒ€']} | ìš´ì˜ ì‹œê°„: {row['ìš´ì˜ ì‹œê°„']} | ê±°ë¦¬: {row['ê±°ë¦¬ ì •ë³´']} | í‰ì : {row['í•™ìƒ í‰ê°€']} | ë¦¬ë·°: {row['í‰ê°€ ë‚´ìš©']}"
        for _, row in df_data.iterrows()
    ])

    # 2. í•™ì‹ ì •ë³´ ë³€í™˜
    cafeteria_string = "ì •ë³´ ì—†ìŒ"
    if weekly_menu_data and isinstance(weekly_menu_data, list):
        cafeteria_lines = []
        for item in weekly_menu_data:
            category = item.get('êµ¬ë¶„', 'êµ¬ë¶„ ì—†ìŒ')
            for key, value in item.items():
                if key != 'êµ¬ë¶„':
                    cafeteria_lines.append(f"[{category}] {key}: {value}")
        cafeteria_string = "\n".join(cafeteria_lines)

    current_time_info = datetime.now().strftime("%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„")

    return f"""
ë‹¹ì‹ ì€ 'ë™ì–‘ë¯¸ë˜ëŒ€í•™êµ ìº í¼ìŠ¤ ë§›ì§‘ í‚¤ì˜¤ìŠ¤í¬'ì˜ ì¹œì ˆí•œ AI ì§ì›ì…ë‹ˆë‹¤.
í˜„ì¬ ì‹œê°„ì€ '{current_time_info}' ì…ë‹ˆë‹¤.

ë‹¹ì‹ ì€ ì•„ë˜ ì œê³µëœ **ë‘ ê°€ì§€ ë°ì´í„°(ì£¼ë³€ ì‹ë‹¹, êµ¬ë‚´ ì‹ë‹¹)**ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤.

---
# 1. êµ¬ë‚´ ì‹ë‹¹(í•™ì‹) ì£¼ê°„ ë©”ë‰´ ì •ë³´
{cafeteria_string}
---
# 2. ì£¼ë³€ ì‹ë‹¹ ë°ì´í„° (ì‹¤ì‹œê°„ í•™ìƒ í‰ì  ë°˜ì˜ë¨)
{restaurant_string}
---

# ì‘ë‹µ ê·œì¹™
1. **í•™ì‹(êµ¬ë‚´ ì‹ë‹¹)** ê´€ë ¨ ì§ˆë¬¸ì´ ë“¤ì–´ì˜¤ë©´ ìœ„ '1. êµ¬ë‚´ ì‹ë‹¹ ì •ë³´'ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚ ì§œì— ë§ì¶° ì •í™•íˆ ë‹µë³€í•˜ì„¸ìš”.
2. **ì£¼ë³€ ë§›ì§‘** ì§ˆë¬¸ì´ ë“¤ì–´ì˜¤ë©´ '2. ì£¼ë³€ ì‹ë‹¹ ë°ì´í„°'ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì²œí•˜ì„¸ìš”.
3. ì‚¬ìš©ìê°€ ë‹¨ìˆœíˆ "ë°¥ ì¶”ì²œí•´ì¤˜"ë¼ê³  í•˜ë©´, í•™ì‹ ë©”ë‰´ì™€ ì£¼ë³€ ë§›ì§‘ ì¤‘ ì¢‹ì€ ì„ íƒì§€ë¥¼ í•¨ê»˜ ê³ ë ¤í•˜ì—¬ ì œì•ˆí•˜ì„¸ìš”.
4. ëª¨ë“  ì‘ë‹µì€ í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê³  ëª…ë£Œí•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.
"""

# --- ìŒì„± ì¶œë ¥ì„ ìœ„í•œ JavaScript í•¨ìˆ˜ ì •ì˜ (TTS ê¸°ëŠ¥) ---
def text_to_speech(text):
    safe_text = json.dumps(text)
    js_code = f"""
        var text = {safe_text}.replace(/\\n/g, ' '); 
        var utterance = new SpeechSynthesisUtterance(text);
        var voices = window.speechSynthesis.getVoices();
        var korean_voice = voices.find(voice => voice.lang === 'ko-KR');
        if (korean_voice) {{ utterance.voice = korean_voice; }}
        utterance.rate = 1.0; 
        window.speechSynthesis.speak(utterance);
    """
    st.components.v1.html(f"<script>{js_code}</script>", height=0, width=0)

def format_date_for_display(date_str):
    try:
        date_obj = datetime.strptime(date_str, "%Y.%m.%d").date()
        day_of_week = ["ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼", "ì¼ìš”ì¼"][date_obj.weekday()]
        is_today = (date_obj == datetime.now().date())
        display_str = f"{day_of_week}"
        if is_today: display_str += " (ì˜¤ëŠ˜)"
        return f"{display_str}\n({date_str})"
    except ValueError:
        return date_str

# --- 4. Streamlit ì•± êµ¬ì„± ---
def main():
    try:
        from streamlit_mic_recorder import mic_recorder
    except ImportError:
        st.error("âš ï¸ 'streamlit-mic-recorder' ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. 'pip install streamlit-mic-recorder'ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
        return

    st.set_page_config(page_title="ë™ì–‘ë¯¸ë˜ëŒ€ ë§›ì§‘ í‚¤ì˜¤ìŠ¤í¬") 
    
    st.title("ğŸ’¡ ë™ì–‘ë¯¸ë˜ëŒ€ ë§›ì§‘ í‚¤ì˜¤ìŠ¤í¬")
    st.caption(f"ChatGPT API ì—°ë™ | í˜„ì¬ ì‹œê°„: **{datetime.now().strftime('%Y-%m-%d %H:%M')}**")
    st.markdown("---")

    df_display = get_dynamic_dataframe()
    
    client = None
    if "OPENAI_API_KEY" not in os.environ or os.environ['OPENAI_API_KEY'] == "sk-ì—¬ê¸°ì—_ë°œê¸‰ë°›ì€_í‚¤_ê°’ì„_ì…ë ¥í•˜ì„¸ìš”":
        # Secretsì—ì„œ í‚¤ê°€ ì—†ì„ ë•Œë§Œ ì—ëŸ¬ ë©”ì‹œì§€
        if "OPENAI_API_KEY" not in st.secrets:
            st.error("âš ï¸ OPENAI_API_KEY í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” secrets.toml ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    else:
        try:
            client = openai.OpenAI(api_key=os.environ["OPENAI_API_KEY"])
        except Exception as e:
            st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    # =======================================================
    # 1. ì£¼ë³€ ì‹ë‹¹ ì •ë³´ (ìƒë‹¨)
    # =======================================================
    st.header("1ï¸âƒ£ ì£¼ë³€ ì‹ë‹¹ ì •ë³´ (ì‹¤ì‹œê°„ í•™ìƒ í‰ì )")
    st.dataframe(
        df_display.drop(columns=['í‰ê°€ ë‚´ìš©']), 
        use_container_width=True,
        hide_index=True,
        column_order=("ì´ë¦„", "ì¢…ë¥˜", "ê°€ê²©ëŒ€", "ìš´ì˜ ì‹œê°„", "ê±°ë¦¬ ì •ë³´", "í•™ìƒ í‰ê°€"), 
    )

    st.markdown("---")
    
    # =======================================================
    # 2. ğŸš êµ¬ë‚´ ì‹ë‹¹ ì£¼ê°„ ë©”ë‰´ (í•™ì‹ í¬ë¡¤ë§) - [ë²ˆí˜¸ ìˆ˜ì •ë¨]
    # =======================================================
    st.header("2ï¸âƒ£ ğŸš êµ¬ë‚´ ì‹ë‹¹ ì£¼ê°„ ë©”ë‰´ (í•™ì‹ í¬ë¡¤ë§)")
    
    weekly_menu_data = get_weekly_campus_menu()
    
    if isinstance(weekly_menu_data, list) and weekly_menu_data and 'êµ¬ë¶„' in weekly_menu_data[0]:
        df_menu_wide = pd.DataFrame(weekly_menu_data)
        id_vars = ['êµ¬ë¶„']
        df_long = df_menu_wide.melt(id_vars=id_vars, var_name='ë‚ ì§œ', value_name='ì‹ë‹¨')
        df_long['ìš”ì¼'] = df_long['ë‚ ì§œ'].apply(format_date_for_display)
        df_long = df_long.drop(columns=['ë‚ ì§œ'])
        
        st.dataframe(
            df_long,
            use_container_width=True,
            hide_index=True,
            column_order=["ìš”ì¼", "êµ¬ë¶„", "ì‹ë‹¨"] 
        )
    else:
        error_message = weekly_menu_data[0].get('ë©”ë‰´', "âš ï¸ êµ¬ë‚´ ì‹ë‹¹ ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        st.error(error_message)
        weekly_menu_data = [] 

    st.markdown("---")

    # =======================================================
    # 3. í•™ìƒ í‰ì  ì°¸ì—¬í•˜ê¸° (ì¤‘ì•™) - [ë²ˆí˜¸ ìˆ˜ì •ë¨]
    # =======================================================
    st.header("3ï¸âƒ£ â­ í•™ìƒ í‰ì  ì°¸ì—¬í•˜ê¸°")
    with st.form("rating_form"):
        selected_restaurant = st.selectbox("í‰ê°€í•  ì‹ë‹¹ì„ ì„ íƒí•˜ì„¸ìš”.", df_static['ì´ë¦„'].tolist())
        
        # [ìˆ˜ì •ëœ ë¶€ë¶„] ìŠ¬ë¼ì´ë” ê°’ 0.5 ë‹¨ìœ„ë¡œ ì •í™•í•˜ê²Œ ì„¤ì •
        score = st.slider(
            "í‰ì  (5ì  ë§Œì )",
            min_value=0.5,
            max_value=5.0,
            value=5.0,
            step=0.5
        )
        
        submitted = st.form_submit_button("í‰ì  ì œì¶œí•˜ê¸°")
        if submitted:
            current = st.session_state.ratings[selected_restaurant]
            st.session_state.ratings[selected_restaurant] = {
                'total_score': current['total_score'] + score,
                'count': current['count'] + 1
            }
            save_ratings(st.session_state.ratings)
            st.success(f"**{selected_restaurant}**ì— {score}ì ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!")
            time.sleep(1) 
            st.rerun() 

    st.markdown("---")
    
    # =======================================================
    # 4. AI ì¶”ì²œ ì‹œìŠ¤í…œ (í•˜ë‹¨) - [ë²ˆí˜¸ ìˆ˜ì •ë¨]
    # =======================================================
    st.header("4ï¸âƒ£ ğŸ¤– AIì—ê²Œ ì§ì ‘ ì¶”ì²œë°›ê¸° (ìŒì„± ëŒ€í™” ê°€ëŠ¥)")
    st.info("ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! (ì˜ˆ: 'ì˜¤ëŠ˜ í•™ì‹ ë­ì•¼?', 'ì§€ê¸ˆ í‰ì  ë†’ì€ í•œì‹ ì¶”ì²œí•´ ì¤˜')")

    system_prompt_current = get_system_prompt(df_display, weekly_menu_data)
    
    if not st.session_state.messages:
        st.session_state.messages = [{"role": "system", "content": system_prompt_current}]
    else:
        st.session_state.messages[0] = {"role": "system", "content": system_prompt_current}
    
    chat_log_container = st.container(height=300) 
    with chat_log_container:
        for message in st.session_state.messages:
            if message["role"] != "system":
                with st.chat_message(message["role"]):
                    st.markdown(message["content"])

    col_mic, col_text = st.columns([1, 4])
    with col_mic:
        audio_data = mic_recorder(
            start_prompt="ğŸ¤ ë…¹ìŒ", stop_prompt="â¹ï¸ ì¢…ë£Œ", just_once=True, use_container_width=True, key='mic_input'
        )
    with col_text:
        prompt = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”:", key='text_prompt')

    if prompt and prompt != st.session_state.get('last_prompt_sent'):
        st.session_state.last_prompt_sent = prompt
        st.session_state.messages.append({"role": "user", "content": prompt})
        
        with chat_log_container:
            with st.chat_message("user"):
                st.markdown(prompt)

        if client:
            with st.spinner("AIê°€ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                try:
                    response = client.chat.completions.create(
                        model="gpt-4o-mini", 
                        messages=st.session_state.messages,
                        temperature=0.2 
                    )
                    ai_response = response.choices[0].message.content
                    st.session_state.messages.append({"role": "assistant", "content": ai_response})
                    
                    with chat_log_container:
                        with st.chat_message("assistant"):
                            st.markdown(ai_response)
                            text_to_speech(ai_response)
                except Exception as e:
                    st.error(f"ì˜¤ë¥˜: {e}")

if __name__ == "__main__":
    if 'speech_initialized' not in st.session_state:
        st.components.v1.html(
            "<script>if(window.speechSynthesis.getVoices().length===0){window.speechSynthesis.onvoiceschanged=function(){};}</script>", height=0, width=0
        )
        st.session_state.speech_initialized = True
    main()